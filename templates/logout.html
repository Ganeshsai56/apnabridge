<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logging out...</title>
  <script>
    // Robust logout flow:
    // 1) Try fetch POST /logout with credentials
    // 2) Confirm with /me
    // 3) If still logged in, submit a form POST to /logout (forces navigation and cookie send)
    // 4) If anything goes wrong, navigate directly to backend /logout URL (fallback)
    // Finally clear client storage and redirect to index.html.

    async function tryFetchLogout() {
      console.log("[logout] tryFetchLogout()");
      try {
        const res = await fetch("http://127.0.0.1:5000/logout", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" }
        });
        console.log("[logout] fetch /logout response:", res.status, res.statusText);
        return res.ok;
      } catch (err) {
        console.warn("[logout] fetch /logout failed:", err);
        return false;
      }
    }

    async function checkServerSession() {
      console.log("[logout] checkServerSession() -> /me");
      try {
        const r = await fetch("http://127.0.0.1:5000/me", { credentials: "include" });
        const data = await r.json().catch(()=>({}));
        console.log("[logout] /me returned:", r.status, data);
        return data && data.logged_in === true;
      } catch (err) {
        console.warn("[logout] /me check failed:", err);
        // If we cannot reach /me treat as unknown (return true to trigger fallback)
        return true;
      }
    }

    function submitFormLogout() {
      console.log("[logout] submitFormLogout() - creating and submitting form (fallback)");
      // Create a form and submit it (will navigate the browser to the backend)
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "http://127.0.0.1:5000/logout";
      form.style.display = "none";
      document.body.appendChild(form);
      form.submit();
    }

    function navigateLogout() {
      console.log("[logout] navigateLogout() - window.location.href to backend logout");
      // Navigate directly (will send cookies for that domain)
      window.location.href = "http://127.0.0.1:5000/logout";
    }

    function clearClientState() {
      try { sessionStorage.removeItem("google_user"); } catch(e){}
      try { localStorage.removeItem("google_user"); } catch(e){}
      try { sessionStorage.clear(); localStorage.clear(); } catch(e){}
      console.log("[logout] cleared local/session storage");
    }

    window.onload = async function() {
      // 0) Clear client-side storage first so UI does not show logged-in data
      clearClientState();

      // 1) Try fetch logout
      const fetchOk = await tryFetchLogout();

      // 2) Wait a tiny bit to let server process (safe)
      await new Promise(r => setTimeout(r, 300));

      // 3) Check server session via /me
      const stillLoggedIn = await checkServerSession();

      if (!stillLoggedIn) {
        // Success: server logged out
        alert("You have been logged out successfully!");
        console.log("[logout] server session cleared, redirecting to index.html");
        window.location.href = "index.html";
        return;
      }

      // 4) If fetch failed or server still reports logged in, try form POST fallback
      console.warn("[logout] server still reports logged in after fetch. Trying form POST fallback.");
      submitFormLogout();

      // NOTE: submitting the form navigates away â€” the code below may not run.
      // But if the browser blocks navigation for some reason, we set a timeout to try navigation fallback.
      setTimeout(() => {
        // If we're still on this page after 2 seconds, try direct navigation
        console.error("[logout] still on page after form submit; trying direct navigation fallback.");
        navigateLogout();
      }, 2000);
    }
  </script>
</head>
<body>
</body>
</html>
